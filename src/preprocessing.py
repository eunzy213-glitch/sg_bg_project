# preprocessing.py
# ============================================================
# ë°ì´í„° ì „ì²˜ë¦¬ ë‹¨ê³„
# - ê²°ì¸¡ì¹˜ ì²˜ë¦¬
# - ë²”ì£¼í˜• ê²°ì¸¡ ëŒ€ì²´
# - ì”ì°¨ ê¸°ë°˜ ì´ìƒì¹˜ ì œê±°
# - Isolation Forest ê¸°ë°˜ ì´ìƒì¹˜ ì œê±°
# ============================================================

import numpy as np # ìˆ˜ì¹˜ê³„ì‚° ë¼ì´ë¸ŒëŸ¬ë¦¬
import pandas as pd # DataFrame ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
from sklearn.linear_model import LinearRegression # ì„ í˜•íšŒê·€ ëª¨ë¸
from sklearn.ensemble import IsolationForest  # ì´ìƒì¹˜ íƒì§€ ëª¨ë¸
import logging # âœ… ë¡œê·¸ ì¶œë ¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì¶”ê°€)


# --------------------------------------------------------
# âœ… Logger ì„¤ì • (ì¶”ê°€)
# --------------------------------------------------------
logger = logging.getLogger(__name__)


def preprocess_and_filter_outliers(df):
    """
    ì…ë ¥ ë°ì´í„°(df)ì— ëŒ€í•´ ì „ì²˜ë¦¬ ë° ì´ìƒì¹˜ ì œê±°ë¥¼ ìˆ˜í–‰í•˜ê³ ,
    ì „ì²˜ë¦¬ í›„ ë°ì´í„°(df_clean)ì™€ ì œê±° ìš”ì•½ ë¦¬í¬íŠ¸(report)ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

    Parameters
    ----------
    df : pd.DataFrame
        ì›ë³¸ ë°ì´í„°í”„ë ˆì„ (SG, BG ë° ê¸°íƒ€ ë²”ì£¼í˜• ì»¬ëŸ¼ í¬í•¨ ê°€ëŠ¥)

    Returns
    -------
    df_clean : pd.DataFrame
        ì „ì²˜ë¦¬ + ì´ìƒì¹˜ ì œê±° í›„ì˜ ë°ì´í„°
    report : pd.DataFrame
        ì „ì²˜ë¦¬ ë‹¨ê³„ ì „/í›„ í–‰(row) ìˆ˜ ìš”ì•½
    """
        
    # ì›ë³¸ ë³´í˜¸ë¥¼ ìœ„í•´ ë³µì‚¬
    df = df.copy()
    logger.info(f"ğŸ”¹ ì „ì²˜ë¦¬ ì‹œì‘ | ì…ë ¥ ë°ì´í„° í–‰ ìˆ˜: {len(df)}")

    # --------------------------------------------------------
    # 1ï¸âƒ£ SG, BG ê²°ì¸¡ ì œê±°
    # --------------------------------------------------------
    before_na = len(df)
    df = df.dropna(subset=["SG", "BG"]) # SG, BG ê²°ì¸¡ì¹˜ê°€ ìˆëŠ” í–‰ ì œê±°
    logger.info(f"ğŸ”¹ SG/BG ê²°ì¸¡ ì œê±° | ì œê±°ëœ í–‰ ìˆ˜: {before_na - len(df)}")

    # --------------------------------------------------------
    # 2ï¸âƒ£ ë²”ì£¼í˜• ê²°ì¸¡ ì²˜ë¦¬
    # --------------------------------------------------------
    cat_cols = df.select_dtypes(include="object").columns # dtypeì´ objectì¸ ì»¬ëŸ¼(ë²”ì£¼í˜•) ì„ íƒ
    df[cat_cols] = df[cat_cols].fillna("Unknown") # ë²”ì£¼í˜• ê²°ì¸¡ì¹˜ëŠ” "Unknown"ìœ¼ë¡œ ëŒ€ì²´
    logger.info(f"ğŸ”¹ ë²”ì£¼í˜• ê²°ì¸¡ ì²˜ë¦¬ ì™„ë£Œ | ëŒ€ìƒ ì»¬ëŸ¼: {list(cat_cols)}")

    # --------------------------------------------------------
    # 3ï¸âƒ£ ì”ì°¨ ê¸°ë°˜ ì´ìƒì¹˜ ì œê±°
    # --------------------------------------------------------
    X = df[["SG"]].values
    y = df["BG"].values

    # SG â†’ BG ì„ í˜• íšŒê·€ (baseline)
    lr = LinearRegression()
    lr.fit(X, y)

    # ì˜ˆì¸¡ ë° ì”ì°¨ ê³„ì‚°
    residual = np.abs(y - lr.predict(X))

    # í‰ê·  + 3í‘œì¤€í¸ì°¨ ê¸°ì¤€
    threshold = residual.mean() + 3 * residual.std()
    mask_residual = residual <= threshold

    logger.info(
        f"ğŸ”¹ ì”ì°¨ ê¸°ë°˜ ì´ìƒì¹˜ ì œê±° | threshold={threshold:.2f}, ì œê±°ëœ í–‰ ìˆ˜: {(~mask_residual).sum()}"
    )

    # --------------------------------------------------------
    # 4ï¸âƒ£ Isolation Forest
    # --------------------------------------------------------
    iso = IsolationForest( # Isolation Forest ëª¨ë¸ ìƒì„±
        n_estimators=300,
        contamination=0.03,
        random_state=42
    )

    iso_label = iso.fit_predict(df[["SG", "BG"]]) # ì´ìƒì¹˜ íƒì§€ ìˆ˜í–‰
    mask_iso = iso_label == 1 # ì •ìƒì¹˜ì¸ í–‰ì— ëŒ€í•´ True

    logger.info(
        f"ğŸ”¹ IsolationForest ì´ìƒì¹˜ ì œê±° | ì œê±°ëœ í–‰ ìˆ˜: {(~mask_iso).sum()}"
    )

    # --------------------------------------------------------
    # 5ï¸âƒ£ ìµœì¢… í•„í„°
    # --------------------------------------------------------
    final_mask = mask_residual & mask_iso # ë‘ ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” í–‰ë§Œ ì„ íƒ
    df_clean = df.loc[final_mask] # final_maskì— í•´ë‹¹í•˜ëŠ” í–‰ë§Œ ì„ íƒ

    logger.info(
        f"ğŸ”¹ ìµœì¢… í•„í„° ì™„ë£Œ | ìµœì¢… í–‰ ìˆ˜: {len(df_clean)}"
    )

    # --------------------------------------------------------
    # 6ï¸âƒ£ ë¦¬í¬íŠ¸ ìƒì„±
    # --------------------------------------------------------
    report = pd.DataFrame({ # ì „ì²˜ë¦¬ ì „/í›„ í–‰ ê°œìˆ˜ë¥¼ ê°„ë‹¨íˆ ìš”ì•½í•˜ëŠ” ë¦¬í¬íŠ¸
        "stage": ["original", "after_filter"],
        "rows": [len(df), len(df_clean)]
    })

    logger.info("âœ… ì „ì²˜ë¦¬ ë° ì´ìƒì¹˜ ì œê±° ì™„ë£Œ")

    return df_clean, report # ìµœì¢… ì „ì²˜ë¦¬ ë°ì´í„°ì™€ ìš”ì•½ ë¦¬í¬íŠ¸ ë°˜í™˜
